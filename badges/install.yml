---
# This playbook sets up badges on a server.
# pass the host and user as extra variables.

- hosts: $host
  user: $user
  sudo: yes
  vars:
    badges_venv: "/opt/badges_venv/"
  vars_files:
  - vars/credentials_${host}.yml
  tasks:

  - name: Update apt packages
    apt: update-cache=yes

  - name: Install required software packages
    apt: pkg=$item state=installed
    with_items:
    - git
    - python-dev
    - python-setuptools
    - libssl-dev
    - gettext
    - python-iso8601
    - make
    - apache2
    - libapache2-mod-wsgi

  - name: create badges user
    user: name=badges

  - name: check out badges code
    git: repo=https://github.com/p2pu/badges.git dest=/opt/badges

  - name: update permissions for badges directory
    command: /bin/chown -R badges:badges /opt/badges

  - name: create badges.log file
    command: /usr/bin/touch /opt/badges/badges/badges.log

  - name: set permissions for badges.log
    file: path=/opt/badges/badges/badges.log state=file owner=badges group=www-data mode=0664

  - name: install pip
    easy_install: name=$item
    with_items:
    - pip

  - name: install virtualenv
    pip: name=$item
    with_items:    
    - virtualenv

  - name: get path for virtuanenv
    command: /usr/bin/which virtualenv
    register: virtualenv

  - name: create python virtual environment
    command: ${virtualenv.stdout} --distribute $badges_venv

  - name: install badges dependencies in virtual environment
    pip: requirements=/opt/badges/badges/requirements.txt virtualenv=$badges_venv 

  - name: configure badges settings_local.py
    template: src=templates/opt_badges_badges_settings_local.py.j2 dest=/opt/badges/badges/badges/settings_local.py mode=0640 owner=badges group=www-data

  - name: create uploads file
    command: mkdir /opt/badges/badges/uploads

  - name: create uploads/images file
    command: mkdir /opt/badges/badges/uploads/images

  - name: set permissions for uploads directory so that apache can write to it
    command: /bin/chown -R badges:www-data /opt/badges/badges/uploads

  - name: set mode for uploads directory
    command: /bin/chmod 0775 /opt/badges/badges/uploads

  - name: configure badges wsgi script
    template: src=templates/opt_badges_badges_wsgi_production.wsgi.j2 dest=/opt/badges/badges/badges/production.py

  - name: run syncdb
    command: $badges_venv/bin/python /opt/badges/badges/manage.py syncdb --noinput

  - name: import testdata
    command: $badges_venv/bin/python /opt/badges/badges/manage.py load_test_data /opt/badges/testdata/test_data.json 

  - name: run collectstatic
    command: $badges_venv/bin/python /opt/badges/badges/manage.py collectstatic --noinput

  - name: copy robots.txt
    copy: src=files/robots.txt dest=/opt/badges/badges/staticfiles/robots.txt mode=0644

  - name: configure badges vhost
    template: src=templates/etc_apache2_sites-available_badges.j2 dest=/etc/apache2/sites-available/badges

  - name: disable 000-default vhost
    command: /usr/sbin/a2dissite 000-default
    ignore_errors: yes
    notify:
    - restart apache

  - name: enable badges vhost
    command: /usr/sbin/a2ensite badges #badges-ssl
    notify:
    - restart apache

  handlers:
  - name: restart apache
    service: name=apache2 state=restarted
